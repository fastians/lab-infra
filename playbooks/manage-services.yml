---
# Manage systemd service files
# Usage: ansible-playbook -i inventories/prod/hosts.ini playbooks/manage-services.yml

- name: Manage Monitor Server (brain + probe)
  hosts: monitoring
  gather_facts: false
  roles:
    - { role: prometheus, tags: prometheus }
    - { role: loki, tags: loki }
    - { role: grafana, tags: grafana }
    - { role: alertmanager, tags: alertmanager }
    - { role: blackbox_exporter, tags: blackbox }

- name: Manage Backend app services
  hosts: backend
  gather_facts: false
  tasks:
    - name: Manage Python application services
      include_role:
        name: python_app
      vars:
        app_name: "{{ item.name }}"
        app_port: "{{ item.port }}"
        app_repo_url: "{{ item.repo_url }}"
        app_branch: "{{ item.branch }}"
        app_description: "{{ item.description }}"
      loop: "{{ python_apps }}"

- hosts: backend
  gather_facts: false
  roles:
    - { role: nginx, tags: nginx }
    - { role: promtail, tags: promtail }

- name: Manage Salome app services
  hosts: salome
  gather_facts: false
  tasks:
    - name: Manage Salome application services
      include_role:
        name: python_app
      vars:
        app_name: "{{ item.name }}"
        app_port: "{{ item.port }}"
        app_repo_url: "{{ item.repo_url }}"
        app_branch: "{{ item.branch }}"
        app_description: "{{ item.description }}"
        app_base_dir: "{{ item.app_base_dir | default(omit) }}"
        app_extra_dirs: "{{ item.app_extra_dirs | default(omit) }}"
      loop: "{{ python_apps }}"

- hosts: salome
  gather_facts: false
  roles:
    - { role: nginx, tags: nginx }
    - { role: promtail, tags: promtail }
