---
# Open firewall on backend and salome so the monitor server can scrape node_exporter and FastAPI /metrics.
# Run: ansible-playbook -i inventories/prod/hosts.ini playbooks/open-app-ports-for-monitoring.yml

- name: Allow monitor to scrape backend (node_exporter 9100, FastAPI 8000â€“8002)
  hosts: backend
  become: yes
  vars:
    monitor_ip: "168.107.19.241"
    backend_ports: [9100, 8000, 8001, 8002]
  tasks:
    - name: Ensure UFW is installed
      apt:
        name: ufw
        state: present

    - name: Allow monitor IP to scrape backend ports
      ufw:
        rule: allow
        from: "{{ monitor_ip }}"
        port: "{{ item }}"
        proto: tcp
      loop: "{{ backend_ports }}"

- name: Allow monitor to scrape salome (node_exporter 9100, FastAPI 8000)
  hosts: salome
  become: yes
  vars:
    monitor_ip: "168.107.19.241"
    salome_ports: [9100, 8000]
  tasks:
    - name: Ensure UFW is installed
      apt:
        name: ufw
        state: present

    - name: Allow monitor IP to scrape salome ports
      ufw:
        rule: allow
        from: "{{ monitor_ip }}"
        port: "{{ item }}"
        proto: tcp
      loop: "{{ salome_ports }}"
