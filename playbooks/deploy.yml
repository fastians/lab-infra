---
# Manual deployment playbook with branch support
# Usage: ansible-playbook -i inventories/prod/hosts.ini playbooks/deploy.yml -e service=backendserver -e branch=main

- hosts: "{{ target | default('backend') }}"
  vars:
    service: "{{ service | default('backendserver') }}"
    branch: "{{ branch | default('main') }}"
    script_map:
      backendserver: "/home/mateen_fastians/.deploy/backendserver.sh"
      geoserver: "/home/mateen_fastians/.deploy/geoserver.sh"
      llmserver: "/home/mateen_fastians/.deploy/llmserver.sh"
      salomeserver: "/home/mateen_fastians/opt/deploy.sh"
  
  tasks:
    - name: Validate service name
      assert:
        that:
          - service in ['backendserver', 'geoserver', 'llmserver', 'salomeserver']
        fail_msg: "Invalid service. Must be one of: backendserver, geoserver, llmserver, salomeserver"

    - name: Deploy {{ service }} from branch {{ branch }}
      shell: "{{ script_map[service] }} {{ branch }}"
      become: yes
      become_user: mateen_fastians
      register: deploy_output
      changed_when: "'DEPLOY OK' in deploy_output.stdout"

    - name: Show deployment output
      debug:
        msg: "{{ deploy_output.stdout_lines }}"

    - name: Verify service is running
      systemd:
        name: "{{ service }}.service"
        state: started
      become: yes
      register: service_status

    - name: Deployment summary
      debug:
        msg: 
          - "✅ Service: {{ service }}"
          - "✅ Branch: {{ branch }}"
          - "✅ Status: {{ service_status.status.ActiveState }}"
