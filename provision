#!/bin/bash
# Quick provisioning wrapper script
# Usage: ./provision <server> [options]

set -e

INVENTORY="inventories/prod/hosts.ini"

show_help() {
    cat << EOF
Server Provisioning Tool

Usage: ./provision <server|command> [options]

Run site.yml for one server (by name):
  monitoring-server   Monitor (brain + probe) only
  salome-server      Salome app server only
  backend-server     Backend app server only

Examples:
  ./provision monitoring-server
  ./provision salome-server -vv
  ./provision backend-server

Other commands:
  monitor             Same as monitoring-server, uses provision-monitor.yml
  salome              Same as salome-server, uses provision-salome.yml
  backend             Same as backend-server, uses provision-backend.yml
  verify              Verify all servers health
  check <server>      Check one server only
  open-firewall-ports     Open UFW ports (monitor + app servers for Prometheus scrape)
  help                This message

Options:
  --tags <tags>       Run only specific tags
  --skip-tags <tags>  Skip specific tags
  --check             Dry run (don't make changes)
  -v, -vv, -vvv       Verbose output

EOF
}

case "$1" in
    monitoring-server)
        shift
        echo "‚ñ∂ Running site.yml for monitoring-server only"
        ansible-playbook -i "$INVENTORY" site.yml --limit monitoring-server "$@"
        ;;

    salome-server)
        shift
        echo "‚ñ∂ Running site.yml for salome-server only"
        ansible-playbook -i "$INVENTORY" site.yml --limit salome-server "$@"
        ;;

    backend-server)
        shift
        echo "‚ñ∂ Running site.yml for backend-server only"
        ansible-playbook -i "$INVENTORY" site.yml --limit backend-server "$@"
        ;;

    monitor)
        shift
        echo "üöÄ Provisioning Monitor Server (brain + probe)..."
        ansible-playbook -i "$INVENTORY" playbooks/provision-monitor.yml "$@"
        ;;

    salome)
        shift
        echo "üöÄ Provisioning Salome Server..."
        ansible-playbook -i "$INVENTORY" playbooks/provision-salome.yml "$@"
        ;;
    
    backend)
        shift
        echo "üöÄ Provisioning Backend Server..."
        ansible-playbook -i "$INVENTORY" playbooks/provision-backend.yml "$@"
        ;;
    
    verify)
        shift
        echo "üîç Verifying All Servers..."
        ansible-playbook -i "$INVENTORY" playbooks/verify-servers.yml "$@"
        ;;

    open-firewall-ports|open-monitoring-ports)
        shift
        echo "üîì Opening firewall ports (monitor + backend/salome for Prometheus)..."
        ansible-playbook -i "$INVENTORY" playbooks/open-firewall-ports.yml "$@"
        ;;

    check)
        if [ -z "$2" ]; then
            echo "‚ùå Error: Please specify server (monitoring-server, backend-server, salome-server)"
            exit 1
        fi
        SERVER="$2"
        shift 2
        echo "üîç Checking $SERVER..."
        ansible-playbook -i "$INVENTORY" playbooks/verify-servers.yml --limit "$SERVER" "$@"
        ;;
    
    help|--help|-h)
        show_help
        ;;

    *)
        echo "‚ùå Unknown: '$1'"
        echo ""
        echo "Use a server name: monitoring-server, salome-server, backend-server"
        echo "Or: ./provision help"
        exit 1
        ;;
esac
