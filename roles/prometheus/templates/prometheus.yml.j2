global:
  scrape_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['127.0.0.1:9093']

scrape_configs:

  # =====================
  # PROMETHEUS ITSELF
  # =====================
  - job_name: prometheus
    static_configs:
      - targets: ['localhost:9090']


  # =====================
  # NODE EXPORTERS (all servers)
  # Set prometheus_node_targets in group_vars to override; else uses inventory groups.
  # =====================
  - job_name: nodes
    static_configs:
{% if prometheus_node_targets is defined and prometheus_node_targets | length > 0 %}
{% for item in prometheus_node_targets %}
      - targets: ['{{ item.target }}']
        labels:
          instance: {{ item.instance }}
{% endfor %}
{% else %}
{% set monitor_hosts = groups.get('monitoring', []) %}
{% set backend_hosts = groups.get('backend', []) %}
{% set salome_hosts = groups.get('salome', []) %}
{% for host in monitor_hosts + backend_hosts + salome_hosts %}
      - targets: ['{{ host }}:9100']
        labels:
          instance: {{ host }}
{% endfor %}
{% endif %}

  # =====================
  # BLACKBOX EXPORTER (probe on monitor server)
  # =====================
  - job_name: blackbox_exporter
    static_configs:
      - targets: ['127.0.0.1:9115']
        labels:
          instance: monitor
{% if blackbox_probe_targets is defined and blackbox_probe_targets %}
  - job_name: blackbox_http_probe
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets: {{ blackbox_probe_targets | to_json }}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - target_label: __address__
        replacement: 127.0.0.1:9115
      - source_labels: [__param_target]
        target_label: instance
      - action: replace
        target_label: __address__
        replacement: 127.0.0.1:9115
{% endif %}

  # =====================
  # FASTAPI METRICS (backend: backendserver:8000, geoserver:8001, llmserver:8002 on one machine; salome:8000)
  # Set prometheus_fastapi_targets in group_vars to list all app endpoints.
  # =====================
  - job_name: fastapi
    metrics_path: /metrics
    static_configs:
{% if prometheus_fastapi_targets is defined and prometheus_fastapi_targets | length > 0 %}
{% for item in prometheus_fastapi_targets %}
      - targets: ['{{ item.target }}']
        labels:
          service: {{ item.service }}
          instance: {{ item.instance }}
{% endfor %}
{% else %}
{% for host in groups.get('backend', []) %}
      - targets: ['{{ host }}:8000']
        labels:
          service: backendserver
          instance: backend
      - targets: ['{{ host }}:8001']
        labels:
          service: geoserver
          instance: backend
      - targets: ['{{ host }}:8002']
        labels:
          service: llmserver
          instance: backend
{% endfor %}
{% for host in groups.get('salome', []) %}
      - targets: ['{{ host }}:8000']
        labels:
          service: salomeserver
          instance: salome
{% endfor %}
{% endif %}